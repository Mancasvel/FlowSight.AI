<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowSight DEV Agent</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --success: #2e7d32;
      --error: #c62828;
      --warning: #f57c00;
      --surface: #ffffff;
      --background: #fafafa;
      --on-surface: #212121;
      --on-surface-secondary: #757575;
      --divider: #e0e0e0;
      --elevation-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --elevation-2: 0 3px 6px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.12);
    }
    
    body {
      font-family: 'Roboto', -apple-system, sans-serif;
      background: var(--background);
      color: var(--on-surface);
      min-height: 100vh;
      line-height: 1.5;
    }
    
    .app-bar {
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      box-shadow: var(--elevation-2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .app-bar h1 { font-size: 20px; font-weight: 500; }
    .app-bar .subtitle { font-size: 14px; opacity: 0.87; margin-top: 4px; font-weight: 300; }
    
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    
    .status-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface);
      border-radius: 4px;
      box-shadow: var(--elevation-1);
      margin-bottom: 24px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--error);
    }
    
    .status-indicator.online { background: var(--success); }
    .status-indicator.warning { background: var(--warning); }
    
    .status-text { font-size: 14px; color: var(--on-surface-secondary); }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: var(--surface);
      border-radius: 4px;
      padding: 20px;
      box-shadow: var(--elevation-1);
    }
    
    .stat-card .label {
      font-size: 11px;
      color: var(--on-surface-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .stat-card .value { font-size: 28px; font-weight: 300; color: var(--primary); }
    .stat-card .value.running { color: var(--success); }
    .stat-card .value.stopped { color: var(--error); }
    
    .card {
      background: var(--surface);
      border-radius: 4px;
      box-shadow: var(--elevation-1);
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--divider);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .card-header .material-icons { color: var(--primary); font-size: 24px; }
    .card-header h2 { font-size: 16px; font-weight: 500; color: var(--on-surface); }
    
    .card-content { padding: 24px; }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 12px;
      color: var(--on-surface-secondary);
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--divider);
      border-radius: 4px;
      font-size: 16px;
      font-family: inherit;
      background: var(--surface);
      color: var(--on-surface);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }
    
    .button-group { display: flex; gap: 12px; margin-top: 20px; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 120px;
    }
    
    .btn .material-icons { font-size: 18px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); box-shadow: var(--elevation-2); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #1b5e20; }
    .btn-error { background: var(--error); color: white; }
    .btn-error:hover { background: #b71c1c; }
    .btn-outlined { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
    .btn-outlined:hover { background: rgba(25, 118, 210, 0.08); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .activity-list { max-height: 350px; overflow-y: auto; }
    
    .activity-item {
      padding: 16px 24px;
      border-bottom: 1px solid var(--divider);
      border-left: 4px solid var(--primary);
    }
    
    .activity-item:last-child { border-bottom: none; }
    
    .activity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .activity-time { font-size: 12px; color: var(--on-surface-secondary); font-family: 'Roboto Mono', monospace; }
    
    .activity-type {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 12px;
      background: rgba(25, 118, 210, 0.1);
      color: var(--primary);
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .activity-type.synced { background: rgba(46, 125, 50, 0.1); color: var(--success); }
    .activity-description { font-size: 14px; color: var(--on-surface); line-height: 1.6; }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--on-surface-secondary);
    }
    
    .empty-state .material-icons { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .registration-view, .main-view { display: none; }
    .registration-view.active, .main-view.active { display: block; }
    
    .alert {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .alert-error { background: #ffebee; color: var(--error); border: 1px solid #ffcdd2; }
    .alert-success { background: #e8f5e9; color: var(--success); border: 1px solid #c8e6c9; }
    
    .sync-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }
    
    .sync-badge.synced { background: rgba(46, 125, 50, 0.1); color: var(--success); }
    .sync-badge.pending { background: rgba(245, 124, 0, 0.1); color: var(--warning); }
  </style>
</head>
<body>
  <div class="app-bar">
    <h1>FlowSight DEV Agent</h1>
    <div class="subtitle">Screen analysis with local AI - Activity reports sent to your team</div>
  </div>
  
  <!-- Registration View -->
  <div class="registration-view" id="registrationView">
    <div class="container">
      <div class="card" style="max-width: 500px; margin: 40px auto;">
        <div class="card-header">
          <span class="material-icons">vpn_key</span>
          <h2>Connect to Your Team</h2>
        </div>
        <div class="card-content">
          <p style="color: var(--on-surface-secondary); margin-bottom: 24px;">
            Enter the API key provided by your team administrator to start reporting your activity.
          </p>
          
          <div id="registrationError" class="alert alert-error" style="display: none;"></div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>API Key</label>
            <input type="text" id="apiKeyInput" placeholder="fsk_..." />
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>Your Name</label>
            <input type="text" id="devNameInput" placeholder="John Doe" />
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>Dashboard URL</label>
            <input type="text" id="dashboardUrlInput" placeholder="http://localhost:3000" value="http://localhost:3000" />
          </div>
          
          <button class="btn btn-primary" id="registerBtn" style="width: 100%;">
            <span class="material-icons">login</span>
            Connect
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main View (after registration) -->
  <div class="main-view" id="mainView">
    <div class="container">
      <div class="status-bar">
        <div class="status-indicator" id="statusIndicator"></div>
        <span class="status-text" id="ollamaStatus">Checking Ollama...</span>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 12px;">
          <span class="status-text" id="teamInfo"></span>
          <button class="btn btn-outlined" id="disconnectBtn" style="padding: 6px 12px; min-width: auto;">
            Disconnect
          </button>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="label">Status</div>
          <div class="value" id="statusText">Stopped</div>
        </div>
        <div class="stat-card">
          <div class="label">Reports Sent</div>
          <div class="value" id="reportCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">Interval</div>
          <div class="value" id="intervalValue">30s</div>
        </div>
        <div class="stat-card">
          <div class="label">Sync Status</div>
          <div class="value" id="syncStatus" style="font-size: 16px;">-</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="material-icons">settings</span>
          <h2>Monitoring Settings</h2>
        </div>
        <div class="card-content">
          <div class="form-row">
            <div class="form-group">
              <label>Capture Interval (seconds)</label>
              <input type="number" id="interval" min="10" max="300" value="30" />
            </div>
            <div class="form-group">
              <label>Vision Model</label>
              <select id="visionModel">
                <option value="llava:7b">LLaVA 7B (Recommended)</option>
                <option value="llava:13b">LLaVA 13B (Higher accuracy)</option>
                <option value="bakllava">BakLLaVA</option>
              </select>
            </div>
          </div>
          
          <div class="button-group">
            <button class="btn btn-success" id="startBtn">
              <span class="material-icons">play_arrow</span>
              Start
            </button>
            <button class="btn btn-error" id="stopBtn">
              <span class="material-icons">stop</span>
              Stop
            </button>
            <button class="btn btn-outlined" id="captureBtn">
              <span class="material-icons">camera_alt</span>
              Capture Now
            </button>
            <button class="btn btn-outlined" id="syncBtn">
              <span class="material-icons">sync</span>
              Sync
            </button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="material-icons">history</span>
          <h2>Activity Log</h2>
        </div>
        <div class="activity-list" id="activityLog">
          <div class="empty-state">
            <span class="material-icons">hourglass_empty</span>
            <div>No activity recorded yet</div>
            <div style="font-size: 13px; margin-top: 8px;">Start monitoring to begin capturing screen activity</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { invoke } from 'https://esm.sh/@tauri-apps/api@2.0.0/core';
    
    let isMonitoring = false;
    let monitoringInterval = null;
    let activityLog = [];
    
    // Initialize and check registration status
    async function init() {
      await invoke('initialize_agent');
      const status = await invoke('get_status');
      
      if (status.isRegistered && status.teamId) {
        showMainView();
        document.getElementById('teamInfo').textContent = 'Team: ' + (status.teamId || '').substring(0, 8) + '...';
        await loadActivityLog();
      } else {
        showRegistrationView();
      }
      
      checkOllama();
      updateStatus();
    }
    
    function showRegistrationView() {
      document.getElementById('registrationView').classList.add('active');
      document.getElementById('mainView').classList.remove('active');
    }
    
    function showMainView() {
      document.getElementById('registrationView').classList.remove('active');
      document.getElementById('mainView').classList.add('active');
    }
    
    async function register() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      const devName = document.getElementById('devNameInput').value.trim();
      const dashboardUrl = document.getElementById('dashboardUrlInput').value.trim();
      const errorEl = document.getElementById('registrationError');
      const btn = document.getElementById('registerBtn');
      
      if (!apiKey || !devName) {
        errorEl.textContent = 'Please enter both API key and your name';
        errorEl.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Connecting...';
      errorEl.style.display = 'none';
      
      try {
        // Update config with dashboard URL first
        await invoke('update_config', {
          config: {
            pmDashboardUrl: dashboardUrl,
            devName: devName,
          }
        });
        
        // Register with API key
        const result = await invoke('register_with_api_key', {
          apiKey: apiKey,
          devName: devName,
        });
        
        if (result.success) {
          showMainView();
          document.getElementById('teamInfo').textContent = 'Team: ' + (result.teamId || '').substring(0, 8) + '...';
          await loadActivityLog();
          checkOllama();
        } else {
          errorEl.textContent = result.error || result.message || 'Registration failed';
          errorEl.style.display = 'block';
        }
      } catch (e) {
        errorEl.textContent = 'Connection error: ' + e;
        errorEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-icons">login</span> Connect';
      }
    }
    
    async function disconnect() {
      if (confirm('Disconnect from team? Your local activity log will be preserved.')) {
        await invoke('update_config', {
          config: {
            apiKey: null,
            developerId: null,
            teamId: null,
          }
        });
        showRegistrationView();
      }
    }
    
    async function checkOllama() {
      const indicator = document.getElementById('statusIndicator');
      const status = document.getElementById('ollamaStatus');
      
      try {
        const result = await invoke('check_ollama');
        
        if (result.online) {
          if (result.hasVisionModel) {
            indicator.className = 'status-indicator online';
            status.textContent = 'Ollama + Vision Model Ready';
          } else {
            indicator.className = 'status-indicator warning';
            status.textContent = 'Need LLaVA: ollama pull llava:7b';
          }
          
          const select = document.getElementById('visionModel');
          result.models.forEach(m => {
            if (m.includes('llava') || m.includes('bakllava')) {
              const exists = Array.from(select.options).some(o => o.value === m);
              if (!exists) select.add(new Option(m, m));
            }
          });
        } else {
          indicator.className = 'status-indicator';
          status.textContent = 'Ollama offline - Run: ollama serve';
        }
      } catch (e) {
        indicator.className = 'status-indicator';
        status.textContent = 'Connection error';
      }
    }
    
    async function updateStatus() {
      try {
        const status = await invoke('get_status');
        const statusEl = document.getElementById('statusText');
        
        if (status.isRunning) {
          statusEl.textContent = 'Active';
          statusEl.className = 'value running';
        } else {
          statusEl.textContent = 'Stopped';
          statusEl.className = 'value stopped';
        }
        
        document.getElementById('reportCount').textContent = status.reportsSent || 0;
      } catch (e) {
        console.error('Status error:', e);
      }
    }
    
    async function loadActivityLog() {
      try {
        const reports = await invoke('get_activity_log', { limit: 20 });
        activityLog = reports;
        renderActivityLog();
      } catch (e) {
        console.error('Load log error:', e);
      }
    }
    
    async function captureAndAnalyze() {
      const btn = document.getElementById('captureBtn');
      const originalContent = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';
      
      try {
        const report = await invoke('capture_and_analyze');
        activityLog.unshift(report);
        if (activityLog.length > 20) activityLog.pop();
        renderActivityLog();
        await updateStatus();
      } catch (e) {
        console.error('Capture error:', e);
        alert('Error: ' + e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }
    
    async function syncReports() {
      const btn = document.getElementById('syncBtn');
      const originalContent = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Syncing...';
      
      try {
        const result = await invoke('sync_reports');
        document.getElementById('syncStatus').textContent = 
          result.synced + ' synced, ' + result.pending + ' pending';
        await loadActivityLog();
      } catch (e) {
        console.error('Sync error:', e);
        alert('Sync error: ' + e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    }
    
    function renderActivityLog() {
      const container = document.getElementById('activityLog');
      
      if (activityLog.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <span class="material-icons">hourglass_empty</span>
            <div>No activity recorded yet</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = activityLog.map(item => `
        <div class="activity-item">
          <div class="activity-header">
            <span class="activity-time">${item.timestamp}</span>
            <div>
              <span class="activity-type">${item.activity_type}</span>
              <span class="sync-badge ${item.synced ? 'synced' : 'pending'}">
                ${item.synced ? 'Synced' : 'Pending'}
              </span>
            </div>
          </div>
          <div class="activity-description">${item.description}</div>
        </div>
      `).join('');
    }
    
    async function startMonitoring() {
      if (isMonitoring) return;
      
      try {
        await invoke('start_monitoring');
        isMonitoring = true;
        
        const interval = parseInt(document.getElementById('interval').value) * 1000;
        document.getElementById('intervalValue').textContent = (interval/1000) + 's';
        
        await captureAndAnalyze();
        
        monitoringInterval = setInterval(async () => {
          if (isMonitoring) await captureAndAnalyze();
        }, interval);
        
        await updateStatus();
      } catch (e) {
        console.error('Start error:', e);
      }
    }
    
    async function stopMonitoring() {
      if (!isMonitoring) return;
      
      try {
        await invoke('stop_monitoring');
        isMonitoring = false;
        
        if (monitoringInterval) {
          clearInterval(monitoringInterval);
          monitoringInterval = null;
        }
        
        await updateStatus();
      } catch (e) {
        console.error('Stop error:', e);
      }
    }
    
    // Event listeners
    document.getElementById('registerBtn').addEventListener('click', register);
    document.getElementById('disconnectBtn').addEventListener('click', disconnect);
    document.getElementById('startBtn').addEventListener('click', startMonitoring);
    document.getElementById('stopBtn').addEventListener('click', stopMonitoring);
    document.getElementById('captureBtn').addEventListener('click', captureAndAnalyze);
    document.getElementById('syncBtn').addEventListener('click', syncReports);
    
    document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') register();
    });
    
    // Initialize
    init();
    setInterval(checkOllama, 30000);
    setInterval(updateStatus, 5000);
  </script>
</body>
</html>